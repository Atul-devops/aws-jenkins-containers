:icons:
:linkcss:
:imagesdir: ./images

= Title

This reference architecture demonstrates how to leverage a single delivery pipeline to deploy to multiple orchestrators. This example will show how to simultanesouly deploy to both
 ECS and Kubernetes. This demonstration could be used to deploy to hybrid scenario where you have Kubernetes on premises and ECS in the cloud. Alternatively it could also be use to deploy to
 homogenous clusters in different regions.

image::architecture.png[Architecture]

:toc

=== Pre-Requisites

A fucntioning Kubernetes cluster and config file to authenticate to the cluster, by default this is located at `~/.kube/config`

A functioning ECS cluster, Setup an ECR repository, build the docker container push to repo. Create a service.

Fork github repository. Setup Jenkins. Modify Security Group to allow traffic from GitHub, setup GitHub hook.

http://34.205.2.121/github-webhook/ - this goes into github :-(

Install pip, awscli, github (or use vanilla amazon linux ami and install just docker)

=== Deploy the CloudFormation stack

|===

|Region | Launch Template
| *N. Virginia* (us-east-1)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Ohio* (us-east-2)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Oregon* (us-west-2)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Ireland* (eu-west-1)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Frankfurt* (eu-central-1)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Singapore* (ap-southeast-1)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Sydney* (ap-southeast-2)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

| *Tokyo* (ap-northeast-1)
a| image::./deploy-to-aws.png[link=https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?stackName=Codesuite-Demo&templateURL=https://s3.amazonaws.com/codesuite-demo-public/aws-kube-codesuite.yaml]

|===

=== Prepare ec2 instance

Clone Repository

    git clone https://github.com/omarlari/aws-jenkins-containers.git

Create directory for jenkins data and kube config

    mkdir ~/jenkins-data
    mkdir ~/.kube

Build awscli and kubectl images

    cd aws-jenkins-containers
    docker build -f AWSCLI -t awscli .
    docker build -f KUBECTL -t kubectl .

SCP Kube credentials to instance

    scp ~/.kube/config ec2-user@<yourip>:~/.kube

Test awscli and kubectl

    docker run awscli s3 ls
    docker run -v /home/ec2-user/.kube:/config/.kube kubectl get nodes

Start Jenkins

    chmod u+x ~/aws-jenkins-containers/start-jenkins.sh
    sudo ~/aws-jenkins-containers/start-jenkins.sh

=== Configure Jenkins

image::jenkins-getting-started.png[jenkins]

=== Configure Jenkins Job


== Conclusion
